{"version":3,"file":"Nielsen.js","sources":["../../../../src/Nielsen.js","../../../../src/main.js"],"sourcesContent":["export default class Nielsen extends akamai.amp.Plugin {\n\n  constructor(player, config) {\n    super(player, config)\n\n    this.bindHandlers([\"onadstarted\", \"onadended\", \"onadtimeupdate\"])\n    this.sdk = window.NOLCMB.getInstance()\n\n    const data = this.data.data\n    this.isDTVR = (data.dtvr === true)\n    this.currentTime = 0\n    this.sdk.ggInitialize(data)\n    window.addEventListener(\"beforeunload\", () => this.fireBeacon(\"end\", this.currentTime.toFixed(0)))\n  }\n\n  generateNielsenVO(type) {\n    let vo = {}\n    const events = this.config.events\n\n    switch (type) {\n      case \"content\":\n        if (events.video != null)\n          vo = events.video\n      break\n\n      case \"static\":\n        vo = events.static\n      break\n\n      default:\n        vo = events.ad\n        vo.type = type\n    }\n\n    return vo\n  }\n\n  fireBeacon(eventName, object) {\n    const codes = {\n      \"loadmetadata\": 15,\n      \"play\": 5,\n      \"stop\": 7,\n      \"timeupdate\": 49,\n      \"end\": 57,\n      \"sendID3\": 55\n    }\n\n    this.player.logger.log(`[AMP Nielsen DCR Event] : Event - ${eventName}`, object)\n    this.sdk.ggPM(codes[eventName], object)\n  }\n\n  onready() {\n    const target = this.player.ads\n    if (target != null) {\n      target.addEventListener(\"onadstarted\", this.onadstarted)\n      target.addEventListener(\"onadended\", this.onadended)\n      target.addEventListener(\"onadtimeupdate\", this.onadtimeupdate)\n    }\n  }\n\n  onadstarted(event) {\n    this.adVO = event.detail\n    const type = this.adVO.type\n\n    if (type == \"midroll\" && this.adVO.position == 1)\n      this.fireBeacon(\"stop\", this.currentTime)\n\n    if (type == \"preroll\")\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(\"content\"))\n\n    if (this.adVO != null) {\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(type))\n    }\n  }\n\n  onadended() {\n    this.fireBeacon(\"stop\", this.currentTime)\n    if (this.adVO.type == \"midroll\" && this.adVO.totalAds == adVO.position)\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(\"content\"))\n  }\n\n  onadtimeupdate(event) {\n    const currentTime = Math.floor(event.detail)\n\n    if (this.currentTime != currentTime) {\n      this.currentTime = currentTime\n      this.fireBeacon(\"timeupdate\", this.currentTime)\n    }\n  }\n\n  onstarted() {\n    if (this.adVO && this.adVO.type == \"midroll\") {\n      this.fireBeacon(\"stop\", this.generateNielsenVO(this.adVO.type))\n    }\n    else {\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(\"content\"))\n    }\n  }\n\n  onended() {\n    this.fireBeacon(\"end\", this.currentTime)\n  }\n\n  ontimeupdate(event) {\n    if (this.isDTVR === true)\n      return\n\n    let currentTime = (this.player.media.isLive) ? event.detail : Date.now() / 1000\n    currentTime = Math.floor(currentTime)\n\n    if (this.currentTime != currentTime) {\n      this.currentTime = currentTime\n      this.fireBeacon(\"timeupdate\", this.currentTime)\n    }\n  }\n\n  onmediasequenceaborted() {\n    this.fireBeacon(\"end\", this.currentTime)\n  }\n\n  ontimedmetadata(event) {\n    if (!this.isDTVR)\n      return\n    this.fireBeacon(\"sendID3\", event.data.value.info)\n  }\n}\n","import Nielsen from \"./Nielsen.js\"\n\nakamai.amp.AMP.registerPlugin(\"nielsen\", akamai.amp.Plugin.createFactory(Nielsen))\n\nexport {Nielsen}\n"],"names":["Nielsen","player","config","bindHandlers","sdk","window","NOLCMB","getInstance","data","isDTVR","dtvr","currentTime","ggInitialize","addEventListener","fireBeacon","toFixed","type","vo","events","video","static","ad","eventName","object","codes","logger","log","ggPM","target","ads","onadstarted","onadended","onadtimeupdate","event","adVO","detail","position","generateNielsenVO","totalAds","Math","floor","media","isLive","Date","now","value","info","akamai","amp","Plugin","AMP","registerPlugin","createFactory"],"mappings":"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"}