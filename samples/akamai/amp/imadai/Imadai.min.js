!function(a){"use strict";var e=function(a){function e(a,t){babelHelpers.classCallCheck(this,e);var i=babelHelpers.possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,a,t));if(i.feature="ads",i.inProgress=!1,i.streamManager=null,i.currentAd=null,i.adTimeRemaining=null,i.snapForwardTime=null,i.onAdEvent=i.onAdEvent.bind(i),t.transform!==!1){var r;i.transforms=(r={},babelHelpers.defineProperty(r,akamai.amp.TransformType.MEDIA,{transform:i.mediaTransform.bind(i),priority:1}),babelHelpers.defineProperty(r,akamai.amp.TransformType.TIME,i.timeTransform.bind(i)),babelHelpers.defineProperty(r,akamai.amp.TransformType.SEEK,i.seekTransform.bind(i)),r);for(var n in i.transforms)i.player.addTransform(n,i.transforms[n])}return i}return babelHelpers.inherits(e,a),babelHelpers.createClass(e,[{key:"mediaTransform",value:function(a){var e=this;return new Promise(function(t,i){function r(a,e){return d[a]||o[a]||m[a]||e}var n="live"==a.temporalType,s=n?new google.ima.dai.api.LiveStreamRequest:new google.ima.dai.api.VODStreamRequest,o=a.metadata?a.metadata.media||a.metadata:{},m=e.player.evaluateBindings(e.config,{media:a}),d=akamai.amp.Utils.getSourceByType(a,"application/x-mpegURL");if(null==d)return i("Could not find media");if(d=e.player.evaluateBindings(d,{media:a}),s.adTagParameters=r("adTagParameters"),s.streamActivityMonitorId=r("streamActivityMonitorId"),s.apiKey=r("apiKey",""),n){var l=r("assetKey");if(!l)return t(a);s.assetKey=l,s.attemptPreroll=r("attemptPreroll",!0),e.player.addEventListener(akamai.amp.Events.TIMED_METADATA,function(a){var t=a.detail;e.streamManager&&t&&e.streamManager.onTimedMetadata({TXXX:t.value.data})})}else{var p=r("videoId"),u=r("contentSourceId");if(!u)return t(a);s.contentSourceId=u,s.videoId=p}var g=function i(r){switch(e.logger.log("[AMP IMA DAI] Stream Event: "+r.type,r),e.streamManager.removeEventListener([google.ima.dai.api.StreamEvent.Type.LOADED,google.ima.dai.api.StreamEvent.Type.ERROR],i,!1),r.type){case google.ima.dai.api.StreamEvent.Type.LOADED:a.src=r.getStreamData().url,e.logger.log("[AMP IMA DAI] Media Source Fetched "+a.src);break;case google.ima.dai.api.StreamEvent.Type.ERROR:e.logger.log("[AMP IMA DAI] Media Source Fetch Error",r)}t(a)};e.streamManager.addEventListener([google.ima.dai.api.StreamEvent.Type.LOADED,google.ima.dai.api.StreamEvent.Type.ERROR],g,!1),e.streamManager.requestStream(s)})}},{key:"timeTransform",value:function(a){return this.streamManager.contentTimeForStreamTime(a)}},{key:"seekTransform",value:function(a){return this.streamManager.streamTimeForContentTime(a)}},{key:"onready",value:function(){this.logger.log("[AMP IMA DAI] SDK initialize"),this.streamManager=new google.ima.dai.api.StreamManager(this.player.mediaElement),this.player.ui&&this.player.ui.ads&&this.player.ui.container&&this.streamManager.setClickElement(this.player.ui.ads.container);var a=[];for(var e in google.ima.dai.api.StreamEvent.Type)google.ima.dai.api.StreamEvent.Type.hasOwnProperty(e)&&a.push(google.ima.dai.api.StreamEvent.Type[e]);this.streamManager.addEventListener(a,this.onAdEvent,!1)}},{key:"onmediachange",value:function(){this.inProgress=!1}},{key:"onAdEvent",value:function(a){switch(this.logger.log("[AMP IMA DAI] Event: "+a.type,a),a.type){case google.ima.dai.api.StreamEvent.Type.AD_BREAK_STARTED:this.adBreakStart(a);break;case google.ima.dai.api.StreamEvent.Type.AD_BREAK_ENDED:this.adBreakEnd(a);break;case google.ima.dai.api.StreamEvent.Type.STARTED:this.adStarted(a);break;case google.ima.dai.api.StreamEvent.Type.COMPLETE:this.adEnded(a);break;case google.ima.dai.api.StreamEvent.Type.AD_PROGRESS:this.adProgress(a);break;case google.ima.dai.api.StreamEvent.Type.CLICK:this.adClick(a);break;case google.ima.dai.api.StreamEvent.Type.FIRST_QUARTILE:this.adFirstQuartile(a);break;case google.ima.dai.api.StreamEvent.Type.MIDPOINT:this.adMidpoint(a);break;case google.ima.dai.api.StreamEvent.Type.THIRD_QUARTILE:this.adThirdQuartile(a);break;case google.ima.dai.api.StreamEvent.Type.CUEPOINTS_CHANGED:this.cuePointsChanged(a);break;case google.ima.dai.api.StreamEvent.Type.ERROR:this.adError(a)}}},{key:"adBreakStart",value:function(a){this.inProgress=!0,this.dispatch(akamai.amp.AdEvents.BREAK_START)}},{key:"adStarted",value:function(a){0==this.inProgress&&this.adBreakStart();var e=a.getAd(),t=e.getCompanionAds(),i=e.getAdPodInfo(),r=i.getAdPosition(),n=i.getPodIndex(),s=0==n?"preroll":n==-1?"postroll":"midroll";this.currentAd=new akamai.amp.AdVO(e.getAdId(),e.getTitle(),e.getDuration(),r,s,"ima-dai",null,t,null,e,i.getTotalAds()),this.companions=t,this.dispatch(akamai.amp.AdEvents.LOADED,this.currentAd),this.dispatch(akamai.amp.AdEvents.DURATION_CHANGE,this.currentAd),this.dispatch(akamai.amp.AdEvents.STARTED,this.currentAd)}},{key:"adFirstQuartile",value:function(a){this.dispatch(akamai.amp.AdEvents.FIRST_QUARTILE,this.currentAd)}},{key:"adMidpoint",value:function(a){this.dispatch(akamai.amp.AdEvents.MIDPOINT,this.currentAd)}},{key:"adThirdQuartile",value:function(a){this.dispatch(akamai.amp.AdEvents.THIRD_QUARTILE,this.currentAd)}},{key:"adEnded",value:function(a){this.dispatch(akamai.amp.AdEvents.ENDED,this.currentAd)}},{key:"adBreakEnd",value:function(a){this.inProgress=!1,this.dispatch(akamai.amp.AdEvents.BREAK_END),this.snapForwardTime&&this.snapForwardTime>this.player.mediaElement.currentTime&&(this.player.mediaElement.currentTime=this.snapForwardTime,this.snapForwardTime=null)}},{key:"adProgress",value:function(a){var e=a.getStreamData().adProgressData,t=e.currentTime,i=e.duration;this.dispatch(akamai.amp.AdEvents.TIME_UPDATE,t),this.dispatch(akamai.amp.AdEvents.TIME_REMAINING,Math.floor(i-t))}},{key:"adClick",value:function(a){this.player.paused||this.player.pause(),this.dispatch(akamai.amp.AdEvents.CLICKED,this.currentAd)}},{key:"adError",value:function(a){this.dispatch(akamai.amp.AdEvents.ERROR,a.getStreamData().errorMessage)}},{key:"cuePointsChanged",value:function(a){var e=this;try{var t=[];a.getStreamData().cuepoints.forEach(function(a){t.push({startTime:e.streamManager.contentTimeForStreamTime(a.start)})}),t.length&&(this.player.cues=t)}catch(a){}}},{key:"onseeked",value:function(a){var e=this.player.mediaElement.currentTime,t=this.streamManager.previousCuePointForStreamTime(e);t&&!t.played&&(this.snapForwardTime=e,this.player.mediaElement.currentTime=t.start)}}]),e}(akamai.amp.AdPlugin);akamai.amp.AMP.registerPlugin("imadai",akamai.amp.Plugin.createFactory(e)),a.DAI=e}(this.akamai.amp.imadai=this.akamai.amp.imadai||{});
//# sourceMappingURL=Imadai.min.js.map