{"version":3,"file":"Yospace.js","sources":["../../../../src/YoSpace.js","../../../../src/main.js"],"sourcesContent":["export default class YoSpace extends akamai.amp.AdPlugin {\n  constructor(player, config) {\n    super(player, config)\n\n    this.feature = \"ads\"\n    this.inProgress = false\n\n    this.bindHandlers([\"AdBreakStart\", \"AdBreakEnd\", \"AdvertStart\", \"AdvertEnd\", \"UpdateTimeline\", \"AnalyticsFired\"])\n\n    YSSessionManager.DEFAULTS.DEBUGGING = this.debug\n    this.sdk = {YSSessionManager, YSPlayerEvents}\n\n    this.onclick = this.onclick.bind(this)\n\n    // setup transforms\n    if (config.transform !== false) {\n      this.player.addTransform(akamai.amp.TransformType.MEDIA, this.mediaTransform.bind(this))\n    }\n  }\n\n  onready(event) {\n    // TODO: This is a hack to get around the issue that hlsjs does not convert YoSpace ID3 tags into TextTrack DataCues\n    if (this.player.hls) {\n      this.player.hls.addEventListener(\"hlsFragParsingMetadata\", (event) => {\n        const data = event.detail.data\n\n        if (!data)\n          return\n\n        const textTracks = this.player.textTracks\n        let textTrack = null\n        for (let i = 0, len = textTracks.length; i < len; i++) {\n          if (textTracks[i].kind === \"metadata\") {\n            textTrack = textTracks[i]\n            break\n          }\n        }\n\n        if (textTrack == null)\n          return\n\n        data.samples.forEach((sample) => {\n          const info = akamai.amp.Utils.arrayBufferToString(sample.data).replace(/\\n|\\r|Ã¿/g, \"\")\n          const regex = /(Y[A-Z]{3})([^Y]+)/g\n          if (!regex.test(info))\n            return\n          info.replace(regex, (match, key, value) => {\n            const cue = new VTTCue(sample.pts, data.frag.endPTS, \"\")\n            cue.type = \"org.id3\"\n            cue.value = {\n              key: key,\n              value: key + value,\n              info: value\n            }\n            textTrack.addCue(cue)\n          })\n        })\n      })\n    }\n  }\n\n  mediaTransform(media) {\n    return this.createSession(media)\n      .then((url) => {\n        this.logger.log(\"[AMP YoSpace] Session Created\", url)\n        media.src = url\n        return media\n      })\n  }\n\n  createSession(media, props = {}) {\n    return new Promise((resolve, reject) => {\n      // TODO: Do we need to implement createForNonLinear?\n      const func = (media.temporalType == \"live\") ? \"createForLive\" : \"createForVoD\";\n      this.sessionManager = YSSessionManager[func](media.src, props, (result) => {\n        if (result == \"error\")\n          return reject(\"Could not create session\")\n\n        this.sessionManager.registerPlayer(this)\n\n        resolve(this.sessionManager.masterPlaylist())\n      });\n    });\n  }\n\n  reportEvent(event, detail) {\n    if (this.sessionManager == null)\n      return\n    this.sessionManager.reportPlayerEvent(event, detail)\n  }\n\n  AdBreakStart() {\n    // Function gets called whenever an advert break starts\n    this.player.mediaElement.addEventListener(\"click\", this.onclick)\n\n    this.inProgress = true\n\n    // TODO: We need to figure out how to populate the AdVO object\n    this.dispatch(akamai.amp.AdEvents.BREAK_START, new akamai.amp.AdVO())\n  }\n\n  AdvertStart(mediaId) {\n    // Function gets called at the start of each advert within a break\n    // (except for filler content - eg ident etc)\n\n    this.dispatch(akamai.amp.AdEvents.STARTED, new akamai.amp.AdVO())\n  }\n\n  AdvertEnd(mediaId) {\n    // Function gets called at the end of each advert within a break\n    // (except for filler content - eg ident etc)\n\n    this.dispatch(akamai.amp.AdEvents.ENDED, new akamai.amp.AdVO())\n  }\n\n  AdBreakEnd() {\n    // Function gets called at the end of an advert break signalling a return to main content\n    this.player.mediaElement.removeEventListener(\"click\", this.onclick)\n\n    this.inProgress = false\n    this.dispatch(akamai.amp.AdEvents.BREAK_END, new akamai.amp.AdVO())\n  }\n\n  UpdateTimeline(timeline) {\n    // Function gets called whenever there is updated information concerning the playback timeline\n    // (for VoD and NonLinear content only)\n    console.log(\"YoSpace -> UpdateTimeline\", timeline)\n  }\n\n  AnalyticsFired(call_id, call_data) {\n    // Function gets called whenever an analytics call is made by the SDK.\n  }\n\n  ontimeupdate(event) {\n    this.reportEvent(YSPlayerEvents.POSITION, event.detail)\n  }\n\n  onfullscreenchange(event) {\n    this.reportEvent(YSPlayerEvents.FULLSCREEN, event.detail)\n  }\n\n  onmuted(event) {\n    this.reportEvent(YSPlayerEvents.MUTE, event.detail)\n  }\n\n  ontimedmetadata(event) {\n    const value = event.detail.value\n\n    if (!/^Y/.test(value.key))\n      return\n\n    if (this.id3 == null) {\n      this.id3 = {}\n    }\n\n    this.id3[value.key] = value.info\n\n    const keys = Object.keys(this.id3)\n    const diff = [\"YCSP\", \"YDUR\", \"YMID\", \"YSEQ\", \"YTYP\"].filter(i => !keys.includes(i))\n\n    if (diff.length === 0) {\n      this.reportEvent(YSPlayerEvents.METADATA, this.id3)\n      this.id3 = null\n    }\n  }\n\n  onmediasequencestarted(event) {\n    this.reportEvent(YSPlayerEvents.START)\n  }\n\n  onmediasequenceended(event) {\n    this.reportEvent(YSPlayerEvents.END)\n  }\n\n  onpause(event) {\n    this.reportEvent(YSPlayerEvents.PAUSE)\n  }\n\n  onresume(event) {\n    this.reportEvent(YSPlayerEvents.RESUME)\n  }\n\n  onseeking(event) {\n    this.reportEvent(YSPlayerEvents.SEEK_START, this.player.currentTime)\n  }\n\n  onseeked(event) {\n    this.reportEvent(YSPlayerEvents.SEEK_END, this.player.currentTime)\n  }\n\n  onclick() {\n    this.reportEvent(YSPlayerEvents.CLICK)\n  }\n\n  nonlinear() {\n    let idx = null\n    this.reportEvent(YSPlayerEvents.NONLINEAR, idx)\n  }\n}\n","import YoSpace from \"./YoSpace.js\"\n\nakamai.amp.AMP.registerPlugin(\"yospace\", akamai.amp.Plugin.createFactory(YoSpace))\n\nexport {YoSpace}\n"],"names":["YoSpace","player","config","feature","inProgress","bindHandlers","DEFAULTS","DEBUGGING","debug","sdk","YSSessionManager","YSPlayerEvents","onclick","bind","transform","addTransform","akamai","amp","TransformType","MEDIA","mediaTransform","event","hls","addEventListener","data","detail","textTracks","textTrack","i","len","length","kind","samples","forEach","sample","info","Utils","arrayBufferToString","replace","regex","test","match","key","value","cue","VTTCue","pts","frag","endPTS","type","addCue","media","createSession","then","url","logger","log","src","props","Promise","resolve","reject","func","temporalType","sessionManager","result","registerPlayer","masterPlaylist","reportPlayerEvent","mediaElement","dispatch","AdEvents","BREAK_START","AdVO","mediaId","STARTED","ENDED","removeEventListener","BREAK_END","timeline","call_id","call_data","reportEvent","POSITION","FULLSCREEN","MUTE","id3","keys","Object","diff","filter","includes","METADATA","START","END","PAUSE","RESUME","SEEK_START","currentTime","SEEK_END","CLICK","idx","NONLINEAR","AdPlugin","AMP","registerPlugin","Plugin","createFactory"],"mappings":"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"}